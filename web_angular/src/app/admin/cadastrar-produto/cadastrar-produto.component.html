<div>
  <div class="mb-6">
    <h3 class="text-xl font-bold text-slate-900 mb-2">ðŸ›’ Cadastrar Nova Compra</h3>
    <p class="text-slate-600">Registre produtos comprados que serÃ£o adicionados ao estoque</p>
  </div>

  <form [formGroup]="produtoForm" (ngSubmit)="onSubmit()" class="space-y-6">
    <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
      <!-- Nome do Produto com Autocomplete -->
      <div class="relative">
        <label class="block text-sm font-medium text-slate-700 mb-2">
          Nome do Produto *
        </label>
        <div class="relative">
          <input type="text" formControlName="nome"
            (focus)="mostrarSugestoes() && sugestoes().length > 0 ? mostrarSugestoes.set(true) : null"
            class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-slate-500 focus:border-transparent transition-all duration-200 bg-slate-50 focus:bg-white text-slate-900 placeholder-slate-500"
            placeholder="Ex: iPhone 15 Pro ou Redmi" required />
          @if (buscando()) {
          <div class="absolute right-3 top-1/2 transform -translate-y-1/2">
            <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-slate-400"></div>
          </div>
          }

          <!-- Dropdown de sugestÃµes -->
          @if (mostrarSugestoes() && sugestoes().length > 0) {
          <div
            class="absolute z-50 w-full mt-1 bg-white border border-slate-300 rounded-xl shadow-lg max-h-60 overflow-auto">
            @for (produto of sugestoes(); track produto.id) {
            <button type="button" (click)="selecionarSugestao(produto)"
              class="w-full text-left px-4 py-3 hover:bg-slate-50 transition-colors border-b border-slate-100 last:border-b-0">
              <div class="font-medium text-slate-900">{{ produto.nome }}</div>
              @if (produto.cor) {
              <div class="text-sm text-slate-500">Cor: {{ produto.cor }}</div>
              }
            </button>
            }
          </div>
          }
        </div>
      </div>

      <!-- Cor -->
      <div>
        <label class="block text-sm font-medium text-slate-700 mb-2">
          Cor
        </label>
        <input type="text" formControlName="cor"
          class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-slate-500 focus:border-transparent transition-all duration-200 bg-slate-50 focus:bg-white text-slate-900 placeholder-slate-500"
          placeholder="Ex: Azul, Preto, Branco" />
      </div>
    </div>

    <!-- SeÃ§Ã£o de IdentificaÃ§Ã£o -->
    <div class="space-y-4">
      <div>
        <label class="block text-sm font-medium text-slate-700 mb-3">
          Tipo de IdentificaÃ§Ã£o
        </label>
        <div class="flex space-x-4">
          <label class="flex items-center">
            <input type="radio" name="tipoIdentificacao" value="imei" [checked]="tipoIdentificacao() === 'imei'"
              (change)="tipoIdentificacao.set('imei')" class="mr-2 text-slate-600 focus:ring-slate-500" />
            <span class="text-sm text-slate-700">IMEI</span>
          </label>
          <label class="flex items-center">
            <input type="radio" name="tipoIdentificacao" value="codigoBarras"
              [checked]="tipoIdentificacao() === 'codigoBarras'" (change)="tipoIdentificacao.set('codigoBarras')"
              class="mr-2 text-slate-600 focus:ring-slate-500" />
            <span class="text-sm text-slate-700">CÃ³digo de Barras</span>
          </label>
          <label class="flex items-center">
            <input type="radio" name="tipoIdentificacao" value="ambos" [checked]="tipoIdentificacao() === 'ambos'"
              (change)="tipoIdentificacao.set('ambos')" class="mr-2 text-slate-600 focus:ring-slate-500" />
            <span class="text-sm text-slate-700">Ambos (Opcionais)</span>
          </label>
        </div>
      </div>

      <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
        <!-- Campo IMEI -->
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-2">
            IMEI {{ tipoIdentificacao() === 'imei' ? '*' : '' }}
          </label>
          <input type="text" formControlName="imei" [required]="tipoIdentificacao() === 'imei'" maxlength="15"
            class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-slate-500 focus:border-transparent transition-all duration-200 bg-slate-50 focus:bg-white text-slate-900 placeholder-slate-500 disabled:bg-slate-100 disabled:cursor-not-allowed"
            placeholder="Ex: 123456789012345" />
          @if (tipoIdentificacao() === 'codigoBarras') {
          <p class="text-xs text-slate-500 mt-1">Campo desabilitado - apenas CÃ³digo de Barras selecionado</p>
          }
        </div>

        <!-- Campo CÃ³digo de Barras -->
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-2">
            CÃ³digo de Barras {{ tipoIdentificacao() === 'codigoBarras' ? '*' : '' }}
          </label>
          <input type="text" formControlName="codigoBarras" [required]="tipoIdentificacao() === 'codigoBarras'"
            maxlength="50"
            class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-slate-500 focus:border-transparent transition-all duration-200 bg-slate-50 focus:bg-white text-slate-900 placeholder-slate-500 disabled:bg-slate-100 disabled:cursor-not-allowed"
            placeholder="Ex: 1234567890123" />
          @if (tipoIdentificacao() === 'imei') {
          <p class="text-xs text-slate-500 mt-1">Campo desabilitado - apenas IMEI selecionado</p>
          }
        </div>
      </div>

      <!-- Mensagem informativa para modo "Ambos" -->
      @if (tipoIdentificacao() === 'ambos') {
      <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
        <p class="text-sm text-blue-800">
          ðŸ’¡ <strong>Modo Ambos:</strong> VocÃª pode preencher IMEI, CÃ³digo de Barras ou ambos.
          Pelo menos um dos campos deve ser preenchido para identificar o produto.
        </p>
      </div>
      }
    </div>

    <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
      <!-- Taxa do DÃ³lar -->
      <div>
        <label class="block text-sm font-medium text-slate-700 mb-2">
          Taxa do DÃ³lar *
        </label>
        <div class="relative">
          <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
            <span class="text-slate-500 sm:text-sm">R$</span>
          </div>
          <input type="text" formControlName="taxaDolar" (input)="formatTaxaInput($event)"
            class="w-full pl-10 pr-4 py-3 border border-slate-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-slate-500 focus:border-transparent transition-all duration-200 bg-slate-50 focus:bg-white text-slate-900 placeholder-slate-500"
            placeholder="0,00" required />
        </div>
      </div>

      <!-- Custo em DÃ³lar -->
      <div>
        <label class="block text-sm font-medium text-slate-700 mb-2">
          Custo em DÃ³lar *
        </label>
        <div class="relative">
          <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
            <span class="text-slate-500 sm:text-sm">$</span>
          </div>
          <input type="text" formControlName="custoDolar" (input)="formatCustoInput($event)"
            class="w-full pl-10 pr-4 py-3 border border-slate-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-slate-500 focus:border-transparent transition-all duration-200 bg-slate-50 focus:bg-white text-slate-900 placeholder-slate-500"
            placeholder="0,00" required />
        </div>
      </div>
    </div>

    <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
      <!-- PreÃ§o Calculado -->
      <div>
        <label class="block text-sm font-medium text-slate-700 mb-2">
          PreÃ§o Calculado (Real)
        </label>
        <div class="relative">
          <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
            <span class="text-slate-500 sm:text-sm">R$</span>
          </div>
          <input type="text" [value]="precoCalculado()" disabled
            class="w-full pl-10 pr-4 py-3 border border-slate-300 rounded-xl bg-slate-100 text-slate-900 cursor-not-allowed"
            placeholder="0,00" />
        </div>
        <p class="text-xs text-slate-500 mt-1">
          Custo Ã— Taxa = {{ produtoForm.get('custoDolar')?.value || '0' }} Ã— {{ produtoForm.get('taxaDolar')?.value ||
          '0' }} = R$ {{ precoCalculado() }}
        </p>
      </div>

      <!-- Quantidade -->
      <div>
        <label class="block text-sm font-medium text-slate-700 mb-2">
          Quantidade *
        </label>
        <input #qtdInput type="number" formControlName="quantidade" min="1" (wheel)="qtdInput.blur()"
          class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-slate-500 focus:border-transparent transition-all duration-200 bg-slate-50 focus:bg-white text-slate-900 placeholder-slate-500"
          placeholder="0" required />
      </div>
    </div>

    <!-- DescriÃ§Ã£o -->
    <div>
      <label class="block text-sm font-medium text-slate-700 mb-2">
        DescriÃ§Ã£o
      </label>
      <input type="text" formControlName="descricao"
        class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-slate-500 focus:border-transparent transition-all duration-200 bg-slate-50 focus:bg-white text-slate-900 placeholder-slate-500"
        placeholder="DescriÃ§Ã£o opcional do produto" />
    </div>

    <!-- BotÃ£o Submit -->
    <button type="submit" [disabled]="loading() || produtoForm.invalid"
      class="w-full flex justify-center items-center py-3 px-4 border border-transparent rounded-xl shadow-sm text-sm font-medium text-white bg-gradient-to-r from-slate-600 to-slate-800 hover:from-slate-700 hover:to-slate-900 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-500 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200 transform hover:scale-[1.02] active:scale-[0.98]">
      @if (loading()) {
      <div class="flex items-center">
        <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white mr-3"></div>
        Cadastrando...
      </div>
      } @else {
      Registrar Compra
      }
    </button>
  </form>
</div>