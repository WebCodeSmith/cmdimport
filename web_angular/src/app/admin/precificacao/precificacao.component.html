<div>
  <!-- Header - Estilo Bitrix24 -->
  <div class="mb-5">
    <div class="flex items-center justify-between">
      <div>
        <h3 class="text-lg font-semibold text-slate-900">Precifica√ß√£o</h3>
        <p class="text-sm text-slate-600 mt-0.5">Gerencie despesas e calcule custos</p>
      </div>
      <div class="flex items-center gap-2">
        @if (abaAtiva() === 'despesas') {
        <button (click)="abrirModalNovaCategoria()"
          class="px-4 py-2 text-sm bg-slate-100 text-slate-700 rounded-md hover:bg-slate-200 transition-colors font-medium flex items-center gap-2">
          <span class="material-icons text-[18px]">add</span>
          Nova Categoria
        </button>
        <button (click)="abrirModalNovaDespesa()"
          class="px-4 py-2 text-sm bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition-colors font-medium shadow-sm flex items-center gap-2">
          <span class="material-icons text-[18px]">add</span>
          Adicionar Despesa
        </button>
        }
      </div>
    </div>

    <!-- Abas -->
    <div class="flex border-b border-slate-200 mt-4 gap-1">
      <button (click)="mudarAba('despesas')"
        [class]="abaAtiva() === 'despesas' ? 'border-b-2 border-slate-900 text-slate-900 font-semibold bg-slate-50' : 'text-slate-600 hover:bg-slate-50'"
        class="px-6 py-3 text-sm font-medium transition-colors rounded-t-md">
        Despesas
      </button>
      <button (click)="mudarAba('calculadora')"
        [class]="abaAtiva() === 'calculadora' ? 'border-b-2 border-slate-900 text-slate-900 font-semibold bg-slate-50' : 'text-slate-600 hover:bg-slate-50'"
        class="px-6 py-3 text-sm font-medium transition-colors rounded-t-md">
        Calculadora de Custos
      </button>
    </div>
  </div>

  <!-- ABA DE DESPESAS -->
  @if (abaAtiva() === 'despesas') {
  @if (loading()) {
  <div class="flex items-center justify-center py-12">
    <div class="text-center">
      <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-slate-600 mx-auto mb-4"></div>
      <p class="text-slate-600">Carregando...</p>
    </div>
  </div>
  } @else {
  <div class="grid grid-cols-1 lg:grid-cols-4 gap-5">
    <!-- Sidebar de Categorias -->
    <div class="lg:col-span-1">
      <div class="bg-white border border-slate-200/60 rounded-lg shadow-sm p-4">
        <h4 class="text-sm font-semibold text-slate-900 mb-3">Categorias</h4>
        <div class="space-y-2">
          <button (click)="selecionarCategoria(null)" [class.bg-indigo-50]="categoriaSelecionada() === null"
            [class.text-indigo-700]="categoriaSelecionada() === null"
            [class.border-indigo-500]="categoriaSelecionada() === null"
            [class.bg-slate-50]="categoriaSelecionada() !== null"
            [class.text-slate-700]="categoriaSelecionada() !== null"
            [class.border-slate-200]="categoriaSelecionada() !== null"
            class="w-full text-left px-3 py-2 rounded-md border-2 transition-colors text-sm font-medium">
            Todas as Despesas
          </button>
          @for (categoria of categorias(); track categoria.id) {
          <div class="flex items-center gap-2 group">
            <button (click)="selecionarCategoria(categoria.id)"
              [class.bg-indigo-50]="categoriaSelecionada() === categoria.id"
              [class.text-indigo-700]="categoriaSelecionada() === categoria.id"
              [class.border-indigo-500]="categoriaSelecionada() === categoria.id"
              [class.bg-slate-50]="categoriaSelecionada() !== categoria.id"
              [class.text-slate-700]="categoriaSelecionada() !== categoria.id"
              [class.border-slate-200]="categoriaSelecionada() !== categoria.id"
              class="flex-1 text-left px-3 py-2 rounded-md border-2 transition-colors text-sm font-medium">
              {{ categoria.nome }}
            </button>
            <button (click)="abrirModalGerenciarCategoria(categoria)"
              class="p-1.5 text-indigo-600 hover:text-indigo-700 hover:bg-indigo-50 rounded-md transition-colors opacity-0 group-hover:opacity-100"
              title="Gerenciar categoria">
              <span class="material-icons text-[16px]">settings</span>
            </button>
          </div>
          }
        </div>
      </div>
    </div>

    <!-- Conte√∫do Principal -->
    <div class="lg:col-span-3">
      <!-- Resumo -->
      <div class="bg-white border border-slate-200/60 rounded-lg shadow-sm p-4 mb-5">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
          <div>
            <p class="text-xs font-medium text-slate-600 uppercase tracking-wide">Total de Despesas</p>
            <p class="text-lg font-semibold text-slate-900 mt-1">{{ despesasFiltradasPorSemana().length }}</p>
          </div>
          <div>
            <p class="text-xs font-medium text-slate-600 uppercase tracking-wide">Categoria</p>
            <p class="text-lg font-semibold text-slate-900 mt-1">
              {{ categoriaSelecionada() ? getCategoriaNome(categoriaSelecionada()!) : 'Todas' }}
            </p>
          </div>
          <div>
            <p class="text-xs font-medium text-slate-600 uppercase tracking-wide">
              @if (semanaSelecionada()) {
              Valor da Semana {{ semanaSelecionada() }}
              } @else {
              Valor Total
              }
            </p>
            <p class="text-lg font-semibold text-red-600 mt-1">
              @if (semanaSelecionada()) {
              {{ formatCurrency(obterTotalSemana(semanaSelecionada())) }}
              } @else {
              {{ formatCurrency(totalDespesas()) }}
              }
            </p>
          </div>
          @if (semanaSelecionada()) {
          <div>
            <p class="text-xs font-medium text-slate-600 uppercase tracking-wide">Per√≠odo</p>
            <p class="text-lg font-semibold text-slate-900 mt-1 text-sm">
              {{ obterPeriodoSemana(semanaSelecionada()!) }}
            </p>
          </div>
          }
        </div>
      </div>

      <!-- Abas de Semanas -->
      <div class="bg-white border border-slate-200/60 rounded-lg shadow-sm p-4 mb-5">
        <div class="flex items-center gap-2 flex-wrap">
          <button (click)="selecionarSemana(null)" [class.bg-indigo-600]="semanaSelecionada() === null"
            [class.text-white]="semanaSelecionada() === null" [class.bg-slate-100]="semanaSelecionada() !== null"
            [class.text-slate-700]="semanaSelecionada() !== null"
            class="px-4 py-2 text-sm font-medium rounded-md transition-colors">
            Todas as Semanas
          </button>
          @for (semana of [1, 2, 3, 4]; track semana) {
          <button (click)="selecionarSemana(semana)" [class.bg-indigo-600]="semanaSelecionada() === semana"
            [class.text-white]="semanaSelecionada() === semana" [class.bg-slate-100]="semanaSelecionada() !== semana"
            [class.text-slate-700]="semanaSelecionada() !== semana"
            class="px-4 py-2 text-sm font-medium rounded-md transition-colors">
            Semana {{ semana }}
            <span class="ml-2 text-xs opacity-75">({{ obterPeriodoSemana(semana) }})</span>
            @if (obterTotalSemana(semana) > 0) {
            <span class="ml-2 text-xs font-semibold">- {{ formatCurrency(obterTotalSemana(semana)) }}</span>
            }
          </button>
          }
        </div>
      </div>

      <!-- Tabela de Despesas -->
      @if (despesasFiltradasPorSemana().length === 0) {
      <div class="text-center py-16 bg-white border border-slate-200/60 rounded-lg">
        <div class="w-14 h-14 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-4">
          <svg class="w-7 h-7 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
          </svg>
        </div>
        <h4 class="text-base font-medium text-slate-900 mb-1">Nenhuma despesa encontrada</h4>
        <p class="text-sm text-slate-500">
          @if (categoriaSelecionada()) {
          N√£o h√° despesas nesta categoria. Adicione uma nova despesa.
          } @else {
          Adicione sua primeira despesa para come√ßar.
          }
        </p>
      </div>
      } @else {
      <div class="bg-white border border-slate-200/60 rounded-lg shadow-sm overflow-hidden">
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-slate-50/80 border-b border-slate-200/60">
              <tr>
                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider">Nome</th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider">Categoria
                </th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider">Data</th>
                <th class="px-4 py-3 text-right text-xs font-semibold text-slate-700 uppercase tracking-wider">Valor
                </th>
                <th class="px-4 py-3 text-center text-xs font-semibold text-slate-700 uppercase tracking-wider">A√ß√µes
                </th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-slate-200/60">
              @for (despesa of despesasFiltradasPorSemana(); track despesa.id) {
              <tr class="hover:bg-slate-50/50 transition-colors">
                <td class="px-4 py-3">
                  <div class="flex items-center gap-2">
                    <span
                      class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-700">
                      Semana {{ calcularSemanaDoMes(despesa.data) }}
                    </span>
                    <div>
                      <div class="text-sm font-medium text-slate-900">{{ despesa.nome }}</div>
                      @if (despesa.descricao) {
                      <div class="text-xs text-slate-500 mt-0.5">{{ despesa.descricao }}</div>
                      }
                    </div>
                  </div>
                </td>
                <td class="px-4 py-3">
                  <span
                    class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-indigo-100 text-indigo-700">
                    {{ getCategoriaNome(despesa.categoriaId) }}
                  </span>
                </td>
                <td class="px-4 py-3 whitespace-nowrap">
                  <div class="text-sm text-slate-700">{{ formatDate(despesa.data) }}</div>
                </td>
                <td class="px-4 py-3 whitespace-nowrap text-right">
                  <div class="text-sm font-semibold text-red-600">{{ formatCurrency(despesa.valor) }}</div>
                </td>
                <td class="px-4 py-3 whitespace-nowrap text-center">
                  <button (click)="abrirModalGerenciarDespesa(despesa)"
                    class="p-1.5 text-indigo-600 hover:text-indigo-700 hover:bg-indigo-50 rounded-md transition-colors"
                    title="Gerenciar">
                    <span class="material-icons text-[18px]">settings</span>
                  </button>
                </td>
              </tr>
              }
            </tbody>
          </table>
        </div>
      </div>
      }
    </div>
  </div>
  }
  }

  <!-- ABA DE CALCULADORA DE CUSTOS -->
  @if (abaAtiva() === 'calculadora') {
  <div class="bg-white border border-slate-200/60 rounded-lg shadow-sm p-6">
    <!-- Filtro de Data e Margem -->
    <div class="mb-6">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-2">Selecione a data</label>
          <input type="date" [(ngModel)]="dataSelecionadaCalc" [ngModelOptions]="{standalone: true}"
            class="w-full px-4 py-2 text-sm border border-slate-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-slate-900" />
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-2">Margem de Lucro (%)</label>
          <input type="number" [(ngModel)]="margemLucro" [ngModelOptions]="{standalone: true}" min="0" max="100"
            step="5"
            class="w-full px-4 py-2 text-sm border border-slate-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-slate-900"
            placeholder="Ex: 30" />
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-2">Tipo de Cliente</label>
          <div class="flex gap-2">
            <button type="button" (click)="tipoCliente.set('consumidorFinal')"
              [class.bg-indigo-600]="tipoCliente() === 'consumidorFinal'"
              [class.text-white]="tipoCliente() === 'consumidorFinal'"
              [class.bg-slate-100]="tipoCliente() !== 'consumidorFinal'"
              [class.text-slate-700]="tipoCliente() !== 'consumidorFinal'"
              class="flex-1 px-4 py-2 text-sm font-medium rounded-md transition-colors">
              üë§ Consumidor Final
            </button>
            <button type="button" (click)="tipoCliente.set('revenda')"
              [class.bg-indigo-600]="tipoCliente() === 'revenda'" [class.text-white]="tipoCliente() === 'revenda'"
              [class.bg-slate-100]="tipoCliente() !== 'revenda'" [class.text-slate-700]="tipoCliente() !== 'revenda'"
              class="flex-1 px-4 py-2 text-sm font-medium rounded-md transition-colors">
              üè™ Revenda
            </button>
          </div>
        </div>
        <div class="flex items-end">
          <button (click)="buscarCalculoPorData()" [disabled]="carregandoCalc()"
            class="w-full px-6 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition-colors font-medium shadow-sm disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2">
            @if (carregandoCalc()) {
            <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>
            <span>Carregando...</span>
            } @else {
            <span class="material-icons text-[18px]">search</span>
            <span>Buscar</span>
            }
          </button>
        </div>
      </div>
    </div>

    @if (dataSelecionadaCalc() && !carregandoCalc()) {
    <!-- Resumo -->
    <div class="mb-4">
      <div class="bg-slate-50 border border-slate-200 rounded-lg p-3 mb-4">
        <div class="flex items-center justify-between flex-wrap gap-2">
          <div class="text-sm text-slate-600">
            <span class="font-medium">Data de an√°lise:</span> {{ formatDate(dataSelecionadaCalc()) }}
          </div>
          <div class="text-sm text-slate-600">
            <span class="font-medium">Margem de lucro:</span> {{ margemLucro() }}%
          </div>
          <div class="text-sm text-slate-600">
            <span class="font-medium">Tipo de cliente:</span>
            {{ tipoCliente() === 'revenda' ? 'üè™ Revenda' : 'üë§ Consumidor Final' }}
          </div>
        </div>
      </div>

      <!-- Aviso quando em modo revenda sem categoria de frete -->
      @if (tipoCliente() === 'revenda' && !getCategoriaFreteId()) {
      <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 mb-4">
        <div class="flex items-start gap-2">
          <span class="material-icons text-yellow-600 text-sm">warning</span>
          <p class="text-sm text-yellow-800">
            <strong>Aten√ß√£o:</strong> Nenhuma categoria de frete foi encontrada.
            Crie uma categoria com o nome "Frete" ou "Custo Frete" para usar o modo Revenda corretamente.
          </p>
        </div>
      </div>
      }

      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="bg-red-50 border border-red-200 rounded-lg p-4">
          <div class="text-xs font-medium text-red-600 uppercase tracking-wider mb-1">Total de Despesas</div>
          <div class="text-2xl font-bold text-red-700">{{ formatCurrency(totalDespesasCalc()) }}</div>
        </div>
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
          <div class="text-xs font-medium text-blue-600 uppercase tracking-wider mb-1">Quantidade de Produtos</div>
          <div class="text-2xl font-bold text-blue-700">{{ quantidadeProdutosCalc() }} un</div>
        </div>
        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
          <div class="text-xs font-medium text-green-600 uppercase tracking-wider mb-1">Lucro Total Estimado</div>
          <div class="text-2xl font-bold text-green-700">{{ formatCurrency(lucroTotalEstimado()) }}</div>
        </div>
      </div>
    </div>

    @if (despesasCalc().length > 0) {
    <!-- Despesas Agrupadas por Categoria -->
    <div class="mb-6">
      <h4 class="text-sm font-semibold text-slate-900 mb-3">Despesas do Dia por Categoria</h4>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        @for (item of categoriasComDespesas(); track item.categoria.id) {
        <div class="bg-white border border-slate-200 rounded-lg shadow-sm overflow-hidden">
          <div class="bg-indigo-50 px-4 py-2 border-b border-indigo-200">
            <div class="flex justify-between items-center">
              <h5 class="text-sm font-semibold text-indigo-900">{{ item.categoria.nome }}</h5>
              <span class="text-xs font-bold text-indigo-700">{{ formatCurrency(item.total) }}</span>
            </div>
          </div>
          <div class="p-3">
            <div class="space-y-2">
              @for (despesa of item.despesas; track despesa.id) {
              <div class="flex justify-between items-center text-xs py-1">
                <span class="text-slate-700">{{ despesa.nome }}</span>
                <span class="font-medium text-slate-900">{{ formatCurrency(despesa.valor) }}</span>
              </div>
              }
            </div>
            <div class="mt-3 pt-2 border-t border-slate-200">
              <div class="text-xs text-slate-600">
                <span class="font-medium">Custo por produto:</span>
                <span class="font-bold text-orange-600 ml-1">{{
                  formatCurrency(custoPorCategoriaPorProduto()[item.categoria.id]) }}</span>
              </div>
            </div>
          </div>
        </div>
        }
      </div>
    </div>
    }

    @if (produtosCalc().length > 0) {
    <!-- Tabela de Produtos com Custos -->
    <div>
      <h4 class="text-sm font-semibold text-slate-900 mb-3">Produtos com Precifica√ß√£o</h4>
      <div class="bg-white border border-slate-200/60 rounded-lg shadow-sm overflow-hidden">
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-slate-50/80 border-b border-slate-200/60">
              <tr>
                <th
                  class="px-4 py-3 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider sticky left-0 bg-slate-50/80">
                  Produto</th>
                <th class="px-4 py-3 text-center text-xs font-semibold text-slate-700 uppercase tracking-wider">Qtd</th>
                <th class="px-4 py-3 text-right text-xs font-semibold text-slate-700 uppercase tracking-wider">Pre√ßo
                  Unit.</th>

                <!-- Colunas din√¢micas para cada categoria -->
                @for (item of categoriasComDespesas(); track item.categoria.id) {
                <th
                  class="px-4 py-3 text-right text-xs font-semibold text-slate-700 uppercase tracking-wider bg-orange-50/50">
                  {{ item.categoria.nome }}
                </th>
                }

                <th
                  class="px-4 py-3 text-right text-xs font-semibold text-slate-700 uppercase tracking-wider bg-slate-100">
                  Custo Total</th>
                <th
                  class="px-4 py-3 text-right text-xs font-semibold text-slate-700 uppercase tracking-wider bg-green-50">
                  Pre√ßo Sugerido</th>
                <th
                  class="px-4 py-3 text-right text-xs font-semibold text-slate-700 uppercase tracking-wider bg-green-50">
                  Lucro Unit.</th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-slate-200/60">
              @for (produto of produtosComCusto(); track produto.id) {
              <tr class="hover:bg-slate-50/50 transition-colors">
                <td class="px-4 py-3 sticky left-0 bg-white">
                  <div class="text-sm font-medium text-slate-900">{{ produto.nome }}</div>
                  @if (produto.cor) {
                  <div class="text-xs text-slate-500 mt-0.5">{{ produto.cor }}</div>
                  }
                </td>
                <td class="px-4 py-3 text-center">
                  <span
                    class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-700">
                    {{ produto.quantidade }}
                  </span>
                </td>
                <td class="px-4 py-3 text-right">
                  <div class="text-sm text-slate-700">{{ formatCurrency(produto.preco) }}</div>
                </td>

                <!-- Custos por categoria (din√¢mico) -->
                @for (item of categoriasComDespesas(); track item.categoria.id) {
                <td class="px-4 py-3 text-right bg-orange-50/30">
                  <div class="text-sm font-semibold text-orange-700">
                    {{ formatCurrency((produto.custosPorCategoria[item.categoria.id] || 0) / produto.quantidade) }}
                  </div>
                  <div class="text-xs text-slate-500">
                    {{ formatCurrency(produto.custosPorCategoria[item.categoria.id] || 0) }} total
                  </div>
                </td>
                }

                <td class="px-4 py-3 text-right bg-slate-100">
                  <div class="text-sm font-bold text-slate-900">{{ formatCurrency(produto.custoFinal) }}</div>
                </td>
                <td class="px-4 py-3 text-right bg-green-50">
                  <div class="text-base font-bold text-green-600">{{ formatCurrency(produto.precoVendaSugerido) }}</div>
                  <div class="text-xs text-green-700 font-medium">+{{ margemLucro() }}%</div>
                </td>
                <td class="px-4 py-3 text-right bg-green-50">
                  <div class="text-sm font-semibold text-green-600">{{ formatCurrency(produto.lucroUnitario) }}</div>
                  <div class="text-xs text-slate-500">{{ formatCurrency(produto.lucroTotal) }} total</div>
                </td>
              </tr>
              }
            </tbody>
          </table>
        </div>
      </div>
    </div>
    } @else {
    <div class="text-center py-12">
      <span class="material-icons text-slate-300 text-6xl mb-3">inventory_2</span>
      <p class="text-slate-600">Nenhum produto encontrado nesta data</p>
    </div>
    }
    } @else if (!carregandoCalc()) {
    <div class="text-center py-12">
      <span class="material-icons text-slate-300 text-6xl mb-3">calendar_today</span>
      <p class="text-slate-600">Selecione uma data e clique em "Buscar" para calcular os custos</p>
    </div>
    }
  </div>
  }

  <!-- Modal Nova Categoria -->
  @if (modalNovaCategoria()) {
  <div class="fixed inset-0 bg-black bg-opacity-50 z-[60] flex items-center justify-center p-4"
    (click)="fecharModalNovaCategoria()">
    <div class="bg-white rounded-lg shadow-xl max-w-md w-full" (click)="$event.stopPropagation()">
      <div class="p-6">
        <h3 class="text-lg font-semibold text-slate-900 mb-4">Nova Categoria</h3>
        <form [formGroup]="formularioCategoria" (ngSubmit)="salvarCategoria()" class="space-y-4">
          <div>
            <label class="block text-xs font-medium text-slate-600 mb-1.5">Nome da Categoria *</label>
            <input type="text" formControlName="nome"
              class="w-full px-3 py-2 text-sm border border-slate-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-slate-900 placeholder-slate-400"
              placeholder="Ex: Aluguel, Despesas de Funcion√°rio" required />
          </div>
          <div>
            <label class="block text-xs font-medium text-slate-600 mb-1.5">Descri√ß√£o</label>
            <textarea formControlName="descricao" rows="3"
              class="w-full px-3 py-2 text-sm border border-slate-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-slate-900 placeholder-slate-400 resize-none"
              placeholder="Ex: Aluguel de carro, apto, aluguel de casa"></textarea>
          </div>
          <div class="flex items-center justify-end gap-2 pt-4 border-t border-slate-200">
            <button type="button" (click)="fecharModalNovaCategoria()"
              class="px-4 py-2 text-sm font-medium text-slate-600 bg-slate-100 rounded-md hover:bg-slate-200 transition-colors">
              Cancelar
            </button>
            <button type="submit" [disabled]="salvandoCategoria() || formularioCategoria.invalid"
              class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-md hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors shadow-sm">
              @if (salvandoCategoria()) {
              <span class="flex items-center gap-2">
                <div class="animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent"></div>
                Salvando...
              </span>
              } @else {
              Criar Categoria
              }
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
  }

  <!-- Modal Nova Despesa -->
  @if (modalNovaDespesa()) {
  <div class="fixed inset-0 bg-black bg-opacity-50 z-[60] flex items-center justify-center p-4"
    (click)="fecharModalNovaDespesa()">
    <div class="bg-white rounded-lg shadow-xl max-w-md w-full" (click)="$event.stopPropagation()">
      <div class="p-6">
        <h3 class="text-lg font-semibold text-slate-900 mb-4">Adicionar Despesa</h3>
        <form [formGroup]="formularioDespesa" (ngSubmit)="salvarDespesa()" class="space-y-4">
          <div>
            <label class="block text-xs font-medium text-slate-600 mb-1.5">Nome da Despesa *</label>
            <input type="text" formControlName="nome"
              class="w-full px-3 py-2 text-sm border border-slate-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-slate-900 placeholder-slate-400"
              placeholder="Ex: Aluguel do apartamento" required />
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-xs font-medium text-slate-600 mb-1.5">Valor *</label>
              <div class="relative">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                  <span class="text-slate-500 text-sm">R$</span>
                </div>
                <input type="text" formControlName="valor"
                  class="w-full pl-9 pr-3 py-2 text-sm border border-slate-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-slate-900 placeholder-slate-400"
                  placeholder="0,00" required />
              </div>
            </div>
            <div>
              <label class="block text-xs font-medium text-slate-600 mb-1.5">Data *</label>
              <input type="date" formControlName="data"
                class="w-full px-3 py-2 text-sm border border-slate-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-slate-900"
                required />
            </div>
          </div>
          <div>
            <label class="block text-xs font-medium text-slate-600 mb-1.5">Categoria *</label>
            <select formControlName="categoriaId"
              class="w-full px-3 py-2 text-sm border border-slate-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-slate-900 bg-white"
              required>
              <option value="">Selecione uma categoria</option>
              @for (categoria of categorias(); track categoria.id) {
              <option [value]="categoria.id">{{ categoria.nome }}</option>
              }
            </select>
          </div>
          <div>
            <label class="block text-xs font-medium text-slate-600 mb-1.5">Descri√ß√£o</label>
            <textarea formControlName="descricao" rows="3"
              class="w-full px-3 py-2 text-sm border border-slate-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-slate-900 placeholder-slate-400 resize-none"
              placeholder="Descri√ß√£o opcional"></textarea>
          </div>
          <div class="flex items-center justify-end gap-2 pt-4 border-t border-slate-200">
            <button type="button" (click)="fecharModalNovaDespesa()"
              class="px-4 py-2 text-sm font-medium text-slate-600 bg-slate-100 rounded-md hover:bg-slate-200 transition-colors">
              Cancelar
            </button>
            <button type="submit" [disabled]="salvandoDespesa() || formularioDespesa.invalid"
              class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-md hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors shadow-sm">
              @if (salvandoDespesa()) {
              <span class="flex items-center gap-2">
                <div class="animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent"></div>
                Salvando...
              </span>
              } @else {
              Adicionar Despesa
              }
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
  }

  <!-- Panel Modal Gerenciar Categoria -->
  <app-panel-modal [isOpen]="modalGerenciarCategoria()" [title]="'Gerenciar Categoria'"
    [subtitle]="categoriaEditando() ? categoriaEditando()!.nome : ''" [menuItems]="gerenciarCategoriaMenuItems"
    [selectedMenuItemId]="selectedGerenciarCategoriaItem()"
    (menuItemSelected)="onGerenciarCategoriaMenuItemSelected($event)" (close)="fecharModalGerenciarCategoria()">

    @if (selectedGerenciarCategoriaItem() === 'editar') {
    <div class="p-6 space-y-5">
      <form [formGroup]="formularioEditarCategoria" (ngSubmit)="salvarEdicaoCategoria()" class="space-y-4">
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1.5">Nome da Categoria *</label>
          <input type="text" formControlName="nome"
            class="w-full px-3 py-2 text-sm border border-slate-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-slate-900 placeholder-slate-400"
            required />
        </div>
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1.5">Descri√ß√£o</label>
          <textarea formControlName="descricao" rows="3"
            class="w-full px-3 py-2 text-sm border border-slate-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-slate-900 placeholder-slate-400 resize-none"></textarea>
        </div>
        <div class="flex items-center justify-end gap-2 pt-4 border-t border-slate-200">
          <button type="button" (click)="fecharModalGerenciarCategoria()"
            class="px-4 py-2 text-sm font-medium text-slate-600 bg-slate-100 rounded-md hover:bg-slate-200 transition-colors">
            Cancelar
          </button>
          <button type="submit" [disabled]="salvandoEdicaoCategoria() || formularioEditarCategoria.invalid"
            class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-md hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors shadow-sm">
            @if (salvandoEdicaoCategoria()) {
            <span class="flex items-center gap-2">
              <div class="animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent"></div>
              Salvando...
            </span>
            } @else {
            Salvar Altera√ß√µes
            }
          </button>
        </div>
      </form>
    </div>
    } @else if (selectedGerenciarCategoriaItem() === 'deletar') {
    <div class="p-6">
      <div class="text-center">
        <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
          <span class="material-icons text-red-600 text-3xl">delete</span>
        </div>
        <h3 class="text-lg font-semibold text-slate-900 mb-2">Deletar Categoria</h3>
        <p class="text-sm text-slate-600 mb-6">
          Tem certeza que deseja deletar a categoria <strong>"{{ categoriaEditando()?.nome }}"</strong>?
          <br>
          <span class="text-red-600 font-medium">Todas as despesas desta categoria tamb√©m ser√£o deletadas.</span>
          <br>
          Esta a√ß√£o n√£o pode ser desfeita.
        </p>
        <div class="flex items-center justify-center gap-3">
          <button (click)="fecharModalGerenciarCategoria()"
            class="px-4 py-2 text-sm font-medium text-slate-600 bg-slate-100 rounded-md hover:bg-slate-200 transition-colors">
            Cancelar
          </button>
          <button (click)="confirmarDeletarCategoria()" [disabled]="deletandoCategoria()"
            class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-md hover:bg-red-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors shadow-sm">
            @if (deletandoCategoria()) {
            <span class="flex items-center gap-2">
              <div class="animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent"></div>
              Deletando...
            </span>
            } @else {
            Deletar Categoria
            }
          </button>
        </div>
      </div>
    </div>
    }
  </app-panel-modal>

  <!-- Panel Modal Gerenciar Despesa -->
  <app-panel-modal [isOpen]="modalGerenciarDespesa()" [title]="'Gerenciar Despesa'"
    [subtitle]="despesaEditando() ? despesaEditando()!.nome : ''" [menuItems]="gerenciarMenuItems"
    [selectedMenuItemId]="selectedGerenciarItem()" (menuItemSelected)="onGerenciarMenuItemSelected($event)"
    (close)="fecharModalGerenciarDespesa()">

    @if (selectedGerenciarItem() === 'editar') {
    <div class="p-6 space-y-5">
      <form [formGroup]="formularioEditarDespesa" (ngSubmit)="salvarEdicaoDespesa()" class="space-y-4">
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1.5">Nome da Despesa *</label>
          <input type="text" formControlName="nome"
            class="w-full px-3 py-2 text-sm border border-slate-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-slate-900 placeholder-slate-400"
            required />
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-xs font-medium text-slate-600 mb-1.5">Valor *</label>
            <div class="relative">
              <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <span class="text-slate-500 text-sm">R$</span>
              </div>
              <input type="text" formControlName="valor"
                class="w-full pl-9 pr-3 py-2 text-sm border border-slate-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-slate-900 placeholder-slate-400"
                placeholder="0,00" required />
            </div>
          </div>
          <div>
            <label class="block text-xs font-medium text-slate-600 mb-1.5">Data *</label>
            <input type="date" formControlName="data"
              class="w-full px-3 py-2 text-sm border border-slate-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-slate-900"
              required />
          </div>
        </div>
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1.5">Categoria *</label>
          <select formControlName="categoriaId"
            class="w-full px-3 py-2 text-sm border border-slate-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-slate-900 bg-white"
            required>
            <option value="">Selecione uma categoria</option>
            @for (categoria of categorias(); track categoria.id) {
            <option [value]="categoria.id">{{ categoria.nome }}</option>
            }
          </select>
        </div>
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1.5">Descri√ß√£o</label>
          <textarea formControlName="descricao" rows="3"
            class="w-full px-3 py-2 text-sm border border-slate-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-slate-900 placeholder-slate-400 resize-none"></textarea>
        </div>
        <div class="flex items-center justify-end gap-2 pt-4 border-t border-slate-200">
          <button type="button" (click)="fecharModalGerenciarDespesa()"
            class="px-4 py-2 text-sm font-medium text-slate-600 bg-slate-100 rounded-md hover:bg-slate-200 transition-colors">
            Cancelar
          </button>
          <button type="submit" [disabled]="salvandoEdicao() || formularioEditarDespesa.invalid"
            class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-md hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors shadow-sm">
            @if (salvandoEdicao()) {
            <span class="flex items-center gap-2">
              <div class="animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent"></div>
              Salvando...
            </span>
            } @else {
            Salvar Altera√ß√µes
            }
          </button>
        </div>
      </form>
    </div>
    } @else if (selectedGerenciarItem() === 'deletar') {
    <div class="p-6">
      <div class="text-center">
        <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
          <span class="material-icons text-red-600 text-3xl">delete</span>
        </div>
        <h3 class="text-lg font-semibold text-slate-900 mb-2">Deletar Despesa</h3>
        <p class="text-sm text-slate-600 mb-6">
          Tem certeza que deseja deletar a despesa <strong>"{{ despesaEditando()?.nome }}"</strong>?
          Esta a√ß√£o n√£o pode ser desfeita.
        </p>
        <div class="flex items-center justify-center gap-3">
          <button (click)="fecharModalGerenciarDespesa()"
            class="px-4 py-2 text-sm font-medium text-slate-600 bg-slate-100 rounded-md hover:bg-slate-200 transition-colors">
            Cancelar
          </button>
          <button (click)="confirmarDeletarDespesa()" [disabled]="deletandoDespesa()"
            class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-md hover:bg-red-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors shadow-sm">
            @if (deletandoDespesa()) {
            <span class="flex items-center gap-2">
              <div class="animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent"></div>
              Deletando...
            </span>
            } @else {
            Deletar Despesa
            }
          </button>
        </div>
      </div>
    </div>
    }
  </app-panel-modal>
</div>